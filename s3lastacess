#!/bin/bash

# Set output CSV file
OUTPUT_FILE="s3_bucket_last_access_report.csv"
echo "Bucket Name,Last Event Date,Event Type" > "$OUTPUT_FILE"

# List all S3 buckets in the account
buckets=$(aws s3api list-buckets --query "Buckets[].Name" --output text)

# Specify the time period (e.g., past 365 days) to search for events
start_date=$(date -u -v -365d +"%Y-%m-%d")
end_date=$(date -u +"%Y-%m-%d")

# Loop through each bucket
for bucket in $buckets; do
    echo "Processing bucket: $bucket"

    # Query CloudTrail for the last event of any type for the bucket
    last_event=$(aws cloudtrail lookup-events \
        --trail-name "Default" \
        --lookup-attributes AttributeKey=ResourceName,AttributeValue="$bucket" \
        --start-time "${start_date}T00:00:00Z" --end-time "${end_date}T23:59:59Z" \
        --query "Events | max_by(@, &EventTime)" \
        --output json)
    
    # Check if any events were found
    if [ "$last_event" == "null" ]; then
        echo "No events found for bucket: $bucket within the last 365 days."
        continue
    fi

    # Extract the date and event type
    last_event_date=$(echo "$last_event" | jq -r '.EventTime' | cut -d'T' -f1)
    event_type=$(echo "$last_event" | jq -r '.EventName')

    # Write bucket name, last event date, and event type to CSV
    echo "$bucket,$last_event_date,$event_type" >> "$OUTPUT_FILE"
    echo "Recorded last event date for $bucket: $last_event_date (Event: $event_type)"
done

echo "Report generated: $OUTPUT_FILE"
